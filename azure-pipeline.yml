trigger:
  branches:
    include: ["master", "ossiaco"]
  paths:
    exclude: ["doc", "*.md", ".appveyor.yml", ".travis.yml"]

variables:
- name: VmImage
  value: windows-latest
- name: BuildConfiguration 
  value: Release
- name: Env
  value: ci
- name: netCoreVersion
  value: 3.1.402
- name: nugetVersion
  value: 5.7.0
- name: MajorVersion
  value: 1
- name: MinorVersion
  value: 0
- name: PatchVersion
  value: 0

stages:
- stage: GetVersion
  displayName: Create Assembly Version
  
  jobs:
    - job: create_version
      displayName: Create Chorus Version
      continueOnError: false
      pool:
        vmImage: $(VmImage)

      steps:
      #versioning must follow https://semver.org/ otherwise msbuild fails
      #e.g. 3.0.0-1-100, 3.0.0-preview.1-100. Build portion is generated as part of prerelease ('.' separated) because it's being ignored in nuget package version (e.g. +1-100).
      - checkout: none

      - task: PowerShell@2
        name: powershell
        inputs:
          targetType: inline
          script: |
            [string] $major = '$(MajorVersion)'
            [string] $minor = '$(MinorVersion)'
            [string] $patch = '$(PatchVersion)'
            [string] $buildNumber = '$(Build.BuildId)'

            if ([string]::IsNullOrWhiteSpace($major)) {
              throw "MajorVersion not informed. Please check Azure DevOps variable group 'ChorusVersion'."
            }
            if ([string]::IsNullOrWhiteSpace($minor)) {
              throw "MinorVersion not informed. Please check Azure DevOps variable group 'ChorusVersion'."
            }
            if ([string]::IsNullOrWhiteSpace($patch)) {
              throw "PatchVersion not informed. Please check Azure DevOps variable group 'ChorusVersion'."
            }

            $prefix = '{0}.{1}.{2}' -f $major.Trim(), $minor.Trim(), $patch.Trim()
            $version = '{0}.{1}.{2}-{3}' -f $major.Trim(), $minor.Trim(), $patch.Trim(), $buildNumber
            Write-Output ('chorus version prefix: {0}' -f $prefix);
            Write-Output ('chorus version: {0}' -f $version);
            Write-Host "##vso[task.setvariable variable=versionPrefix;isOutput=true]$prefix"
            Write-Host "##vso[task.setvariable variable=buildVersion;isOutput=true]$version"

          failOnStderr: true
        displayName: Generate Chorus Version

- stage: Build_Solution
  displayName: Build Code Generator
  dependsOn: GetVersion
  variables:
  - name: versionPrefix
    value: $[ stageDependencies.GetVersion.create_version.outputs['powershell.versionPrefix'] ]
  - name: buildVersion
    value: $[ stageDependencies.GetVersion.create_version.outputs['powershell.buildVersion'] ]

  jobs:
  - job: build_codegen_solution
    displayName: Build Code Generator
    continueOnError: false
    timeoutInMinutes: 30  
    pool:
      vmImage: $(VmImage)
  
    steps:

    - task: UseDotNet@2
      inputs:
        packageType: sdk
        version: $(netCoreVersion)
        installationPath: $(Agent.ToolsDirectory)/dotnet
        includePreviewVersions: true
        performMultiLevelLookup: true
 
    - checkout: self 
      submodules: recursive
      clean: true
      lfs: true
  
    - task: DotNetCoreCLI@2
      displayName: 'dotnet build $(buildConfiguration)'
      inputs:
        command: build
        projects: CodeGeneration.Chorus.sln
        arguments: --configuration $(BuildConfiguration) -p:OS=$(OS) -p:FileVersion=$(versionPrefix) -p:Version=$(buildVersion) -m:1 -nowarn:OCC001

    - task: NuGetAuthenticate@0
      displayName: 'NuGet Authenticate'
    - task: NuGetCommand@2
      displayName: 'NuGet push $(Build.SourcesDirectory)\artifacts\packages\$(buildConfiguration)\Shipping\*.nupkg'
      inputs:
        command: 'push'
        packagesToPush: '$(Build.SourcesDirectory)\artifacts\packages\$(buildConfiguration)\Shipping\*.nupkg;$(Build.SourcesDirectory)\artifacts\packages\$(buildConfiguration)\Shipping\*.snupkg'
        nuGetFeedType: 'internal'
        publishVstsFeed: '65bd3f35-c189-4c0d-b80a-db6cc426db7f/5d7dc4f8-20d4-47a6-be10-7973c07d2daf'
        allowPackageConflicts: true